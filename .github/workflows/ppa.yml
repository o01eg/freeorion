name: "Ubuntu PPA"

on:
  push:
    tags:
      - 'ppa-2[0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9].[0-9a-f]+_[0-9]+'

jobs:
  build-ppa:
    name: PPA ${{ matrix.dist }}
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        dist: [jammy, noble, oracular, plucky]

    steps:
      - name: Checkout sources
        uses: actions/checkout@v4
      - uses: actions/cache@v4
        id: build-ppa-install-cache-id
        with:
          path: ${{ runner.temp }}/cache-build-linux-install
          key: build-ppa-install-cache-key-v1.4
      - uses: airvzxf/cache-anything-new-action@v1.0.1
        with:
          script: 'ppa-install-build.sh'
          is_cached: ${{ steps.build-ppa-install-cache-id.outputs.cache-hit }}
          cache: ${{ runner.temp }}/cache-build-linux-install
          snapshot: '/'
          exclude: '/boot /data /dev /mnt /proc /run /sys'
      - name: Ensure installed packages
        run: bash .github/workflows/ppa-install-build.sh
      - name: Export secret keys
        run: bash .github/pre-deploy.sh
        env:
          DEPLOY_SSH_PASSWORD: ${{ secrets.DEPLOY_SSH_PASSWORD }}
      - name: Prepare version
        run: python cmake/make_versioncpp.py . CMake
      - name: Build
        run: bash .ci/script.sh ${{ matrix.dist }} ${{ github.ref_name }}
      - name: Deploy
        run: bash .ci/deploy.sh ${{ matrix.dist }} ${{ github.ref_name }}    

